{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.8.8", "generated_at": "2024-11-13T01:19:42.354405Z", "invocation_id": "23c785cd-b4c4-4df4-bf0f-8197130d908d", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2024-11-13T01:19:42.155091Z", "completed_at": "2024-11-13T01:19:42.163707Z"}, {"name": "execute", "started_at": "2024-11-13T01:19:42.164808Z", "completed_at": "2024-11-13T01:19:42.308396Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 0.15530109405517578, "adapter_response": {"_message": "SELECT 1000", "code": "SELECT", "rows_affected": 1000}, "message": "SELECT 1000", "failures": null, "unique_id": "model.merchant_data_project.curated_merchant_data", "compiled": true, "compiled_code": "WITH merchant_signup AS (\n    -- Define the 7, 30, 90, 180, 365 day periods after signup for each merchant\n    SELECT\n        merchant_id,\n        sign_up_time,\n        sign_up_time + INTERVAL '7 days' AS signup_plus_7_days,\n        sign_up_time + INTERVAL '30 days' AS signup_plus_30_days,\n        sign_up_time + INTERVAL '90 days' AS signup_plus_90_days,\n        sign_up_time + INTERVAL '180 days' AS signup_plus_180_days,\n        sign_up_time + INTERVAL '365 days' AS signup_plus_365_days\n    FROM \"merchant_data\".\"public\".\"merchants\"\n),\n\n-- Checking the output of merchant signup information\n-- select * from merchant_signup\nsuccessful_transactions AS (\n    -- Get successful transactions per merchant\n    SELECT\n        t.merchant_id,\n        t.server_time_created_at,\n        row_number() OVER (PARTITION BY t.merchant_id ORDER BY t.server_time_created_at) AS transaction_rank\n    FROM \"merchant_data\".\"public\".\"transactions\" t\n    WHERE t.tx_result = 11  -- Only successful transactions\n),\n\nfirst_successful_transaction AS (\n    -- Get first successful transaction date for each merchant\n    SELECT\n        st.merchant_id,\n        min(st.server_time_created_at) AS first_successful_transaction_date\n    FROM successful_transactions st\n    WHERE st.transaction_rank = 1\n    GROUP BY st.merchant_id\n),\n\n-- Checking the output of the first successful transaction\n-- select * from first_successful_transaction\n\nsuccessful_card_present_transactions AS (\n    SELECT\n        t.merchant_id,\n        t.server_time_created_at,\n        row_number() OVER (PARTITION BY t.merchant_id ORDER BY t.server_time_created_at) AS transaction_rank\n    FROM \"merchant_data\".\"public\".\"transactions\" t\n    JOIN \"merchant_data\".\"public\".\"payment_types\" pt\n        ON t.payment_type_code = pt.code  -- Joining ON the payment type code\n    WHERE t.tx_result = 11  -- Successful transaction (tx_result = 11)\n      AND NOT pt.code IN (1,8,9,12,14)  -- Card-not-present transaction codes and code 1 for Cash payment\n),\n\nfirst_card_present_transaction AS (\n    -- Get first card-present transaction date for each merchant\n    SELECT\n        st.merchant_id,\n        min(st.server_time_created_at) AS first_card_present_transaction_date\n    FROM successful_card_present_transactions st\n    WHERE st.transaction_rank = 1  -- Get the first card-present transaction\n    GROUP BY st.merchant_id\n),\n\n-- Checking the output of the first card-present transaction\n-- select * from first_card_present_transaction\n\nfifth_successful_transaction AS (\n    -- Get fifth successful transaction date for each merchant\n    SELECT\n        st.merchant_id,\n        min(st.server_time_created_at) AS fifth_successful_transaction_date\n    FROM successful_transactions st\n    WHERE st.transaction_rank = 5\n    GROUP BY st.merchant_id\n),\n\n-- Checking the output of the fifth successful transaction\n-- select * from fifth_successful_transaction\n\n\nlast_successful_transaction AS (\n    -- Get last successful transaction date for each merchant\n    SELECT\n        st.merchant_id,\n        max(st.server_time_created_at) AS last_successful_transaction_date\n    FROM successful_transactions st\n    WHERE st.transaction_rank = 1\n    GROUP BY st.merchant_id\n),\n\n-- Checking the output of the fifth successful transaction\n-- select * from last_successful_transaction\n\nall_time_successful_transactions AS (\n    -- Get all time successful transaction for each merchant\n   SELECT\n        t.merchant_id,\n        count(*) AS all_time_successful_transactions\n    FROM \"merchant_data\".\"public\".\"transactions\" t\n    WHERE t.tx_result = 11  -- Successful transaction (tx_result = 11)\n    GROUP BY t.merchant_id\n),\n\n-- Checking the output of the all time successful transactions\n-- select * from all_time_successful_transactions\n\nall_time_failed_transactions AS (\n    -- Get all time failed transaction for each merchant\n   SELECT\n        t.merchant_id,\n        count(*) AS all_time_failed_transactions\n    FROM \"merchant_data\".\"public\".\"transactions\" t\n    WHERE t.tx_result != 11  -- failed transaction (tx_result != 11)\n    GROUP BY t.merchant_id\n),\n\n-- Checking the output of the all time failed transactions\n-- select * from all_time_failed_transactions\n\ntransactions_in_period AS (\n    -- Join transactions WITH calculated periods, filtering by successful transactions within 365 days of signup\n    SELECT\n        m.merchant_id,\n        t.amount,\n        CASE\n            WHEN t.server_time_created_at >= m.sign_up_time \n                 AND t.server_time_created_at < m.signup_plus_7_days THEN '7_day'\n            WHEN t.server_time_created_at >= m.sign_up_time\n                 AND t.server_time_created_at < m.signup_plus_30_days THEN '30_day'\n            WHEN t.server_time_created_at >= m.sign_up_time\n                 AND t.server_time_created_at < m.signup_plus_90_days THEN '90_day'\n            WHEN t.server_time_created_at >= m.sign_up_time\n                 AND t.server_time_created_at < m.signup_plus_180_days THEN '180_day'\n            WHEN t.server_time_created_at >= m.sign_up_time\n                 AND t.server_time_created_at < m.signup_plus_365_days THEN '365_day'\n        END AS PERIOD\n    FROM merchant_signup m\n    JOIN \"merchant_data\".\"public\".\"transactions\" t\n        ON m.merchant_id = t.merchant_id\n    WHERE t.tx_result = 11  -- Only successful transactions\n      AND t.server_time_created_at < m.signup_plus_365_days\n),\n\ntpv_summary AS (\n    SELECT\n        merchant_id,\n        sum(CASE WHEN PERIOD = '7_day' THEN amount ELSE 0 END) AS tpv_7_day,\n        sum(CASE WHEN PERIOD IN ('7_day', '30_day') THEN amount ELSE 0 END) AS tpv_30_day,\n        sum(CASE WHEN PERIOD IN ('7_day', '30_day', '90_day') THEN amount ELSE 0 END) AS tpv_90_day,\n        sum(CASE WHEN PERIOD IN ('7_day', '30_day','90_day','180_day') THEN amount ELSE 0 END) AS tpv_180_day,\n        sum(CASE WHEN PERIOD IN ('7_day', '30_day','90_day','180_day','365_day') THEN amount ELSE 0 END) AS tpv_365_day\n    FROM transactions_in_period\n    WHERE PERIOD IS NOT NULL\n    GROUP BY merchant_id\n)\n\n-- Final selection combining all computed metrics\n\nSELECT\n    ms.merchant_id,\n    ms.sign_up_time,\n    fst.first_successful_transaction_date,\n    fcpt.first_card_present_transaction_date,\n    fifth.fifth_successful_transaction_date,\n    lst.last_successful_transaction_date,\n    atst.all_time_successful_transactions,\n    atft.all_time_failed_transactions,\n    tpv.tpv_7_day,\n    tpv.tpv_30_day,\n    tpv.tpv_90_day,\n    tpv.tpv_180_day,\n    tpv.tpv_365_day\n\nFROM merchant_signup ms\nLEFT JOIN first_successful_transaction fst ON ms.merchant_id = fst.merchant_id\nLEFT JOIN first_card_present_transaction fcpt ON ms.merchant_id = fcpt.merchant_id\nLEFT JOIN fifth_successful_transaction fifth ON ms.merchant_id = fifth.merchant_id\nLEFT JOIN last_successful_transaction lst ON ms.merchant_id = lst.merchant_id\nLEFT JOIN all_time_successful_transactions atst ON ms.merchant_id = atst.merchant_id\nLEFT JOIN all_time_failed_transactions atft ON ms.merchant_id = atft.merchant_id\nLEFT JOIN tpv_summary tpv ON ms.merchant_id = tpv.merchant_id\n\nORDER BY fifth.fifth_successful_transaction_date NULLS LAST", "relation_name": "\"merchant_data\".\"public\".\"curated_merchant_data\""}], "elapsed_time": 0.554985761642456, "args": {"macro_debugging": false, "cache_selected_only": false, "strict_mode": false, "project_dir": "C:\\Users\\alvaro\\Desktop\\sumup_assignment\\merchant_data_project", "invocation_command": "dbt run --select curated_merchant_data", "print": true, "static_parser": true, "send_anonymous_usage_stats": true, "log_path": "C:\\Users\\alvaro\\Desktop\\sumup_assignment\\merchant_data_project\\logs", "source_freshness_run_project_hooks": false, "use_colors_file": true, "use_colors": true, "log_format": "default", "indirect_selection": "eager", "introspect": true, "which": "run", "enable_legacy_logger": false, "quiet": false, "populate_cache": true, "require_explicit_package_overrides_for_builtin_materializations": true, "select": ["curated_merchant_data"], "printer_width": 80, "log_level_file": "debug", "require_resource_names_without_spaces": false, "log_file_max_bytes": 10485760, "write_json": true, "log_format_file": "debug", "partial_parse_file_diff": true, "partial_parse": true, "empty": false, "vars": {}, "defer": false, "profiles_dir": "C:\\Users\\alvaro\\.dbt", "warn_error_options": {"include": [], "exclude": []}, "version_check": true, "favor_state": false, "log_level": "info", "show_resource_report": false, "exclude": []}}